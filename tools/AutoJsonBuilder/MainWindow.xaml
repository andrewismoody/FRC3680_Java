<Window x:Class="AutoJsonBuilder.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:oxy="http://oxyplot.org/wpf"
        xmlns:local="clr-namespace:AutoJsonBuilder"
        xmlns:b="clr-namespace:AutoJsonBuilder.Behaviors"
        xmlns:val="clr-namespace:AutoJsonBuilder.Validation"
        Title="AutoJsonBuilder [TOOLS/AUTOJSONBUILDER]" Width="1200" Height="750"
        Background="#14161A" Foreground="#E6E6E6">
  <Window.Resources>
    <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
  </Window.Resources>

  <DockPanel>

    <!-- Menu bar -->
    <Menu DockPanel.Dock="Top" Background="#1B1F24" Foreground="#E6E6E6">
      <Menu.ItemContainerStyle>
        <Style TargetType="{x:Type MenuItem}">
          <Setter Property="Background" Value="#1B1F24"/>
          <Setter Property="Foreground" Value="#E6E6E6"/>
          <Setter Property="Padding" Value="10,4"/>
          <Style.Triggers>
            <Trigger Property="IsHighlighted" Value="True">
              <Setter Property="Background" Value="#21262D"/>
              <Setter Property="Foreground" Value="#E6E6E6"/>
            </Trigger>
            <Trigger Property="IsEnabled" Value="False">
              <Setter Property="Foreground" Value="#8B949E"/>
            </Trigger>
          </Style.Triggers>
        </Style>
      </Menu.ItemContainerStyle>

      <MenuItem Header="_File">
        <MenuItem Header="_New" Command="{Binding NewCommand}" />
        <MenuItem Header="_Open..." Command="{Binding OpenCommand}" />
        <MenuItem Header="Save _As..." Command="{Binding SaveAsCommand}" />
        <Separator/>
        <MenuItem Header="E_xit" Command="ApplicationCommands.Close" />
      </MenuItem>

      <MenuItem Header="_Tools">
        <MenuItem Header="_Refresh From Java Dump" Command="{Binding RefreshCommand}" />
      </MenuItem>
    </Menu>

    <!-- Top toolbar -->
    <Border DockPanel.Dock="Top" Background="#1B1F24" Padding="10">
      <Grid>
        <TextBlock Text="AutoJsonBuilder" FontSize="16" FontWeight="SemiBold" VerticalAlignment="Center" />
      </Grid>
    </Border>

    <!-- Main split -->
    <Grid>
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="380" />
        <ColumnDefinition Width="*" />
      </Grid.ColumnDefinitions>

      <!-- Left: hierarchy tree -->
      <Border Grid.Column="0" Background="#111318" BorderBrush="#2C313A" BorderThickness="0,0,1,0">
        <DockPanel>
          <TextBlock DockPanel.Dock="Top" Text="Hierarchy" Padding="10" FontWeight="SemiBold" Foreground="#C9D1D9"/>

          <TreeView ItemsSource="{Binding TreeRootItems}"
                    b:TreeViewSelectedItemBehavior.AutoFocusSelectedItem="True"
                    Background="#111318"
                    Foreground="#E6E6E6"
                    BorderThickness="0"
                    SelectedItemChanged="TreeView_SelectedItemChanged">
            <TreeView.Resources>
              <Style TargetType="{x:Type TreeViewItem}">
                <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                <Setter Property="Foreground" Value="#E6E6E6"/>
                <Setter Property="Background" Value="Transparent"/>
                <Style.Triggers>
                  <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#21262D"/>
                  </Trigger>
                  <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#2A4B8D"/>
                    <Setter Property="Foreground" Value="White"/>
                  </Trigger>
                </Style.Triggers>
              </Style>

              <HierarchicalDataTemplate DataType="{x:Type local:TreeItemVm}" ItemsSource="{Binding Children}">
                <DockPanel LastChildFill="True">
                  <Button DockPanel.Dock="Right"
                          Width="22" Height="22" Margin="6,0,0,0"
                          Content="ï¼‹" ToolTip="Add"
                          Command="{Binding AddCommand}"
                          Visibility="{Binding HasAdd, Converter={StaticResource BoolToVisibilityConverter}}"/>
                  <Button DockPanel.Dock="Right"
                          Width="22" Height="22" Margin="6,0,0,0"
                          Content="ðŸ—‘" ToolTip="Remove"
                          Command="{Binding RemoveCommand}"
                          Visibility="{Binding HasRemove, Converter={StaticResource BoolToVisibilityConverter}}"/>

                  <Grid>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="Auto"/>
                      <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Caption (editable for non-section nodes) -->
                    <Grid Grid.Column="0">
                      <!-- Label caption (default visible; hidden for Object nodes) -->
                      <TextBlock x:Name="CaptionLabel"
                                 Text="{Binding Title}"
                                 Margin="0,2,8,0">
                        <TextBlock.Style>
                          <Style TargetType="{x:Type TextBlock}">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                              <DataTrigger Binding="{Binding Kind}" Value="{x:Static local:TreeItemKind.Object}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                              </DataTrigger>
                            </Style.Triggers>
                          </Style>
                        </TextBlock.Style>
                      </TextBlock>

                      <!-- Editable caption (default hidden; shown for Object nodes) -->
                      <TextBox x:Name="CaptionEditor"
                               Text="{Binding Caption, UpdateSourceTrigger=PropertyChanged}"
                               Background="#111318" Foreground="#E6E6E6" BorderBrush="#2C313A"
                               Padding="2" MinWidth="140">
                        <TextBox.Style>
                          <Style TargetType="{x:Type TextBox}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                              <DataTrigger Binding="{Binding Kind}" Value="{x:Static local:TreeItemKind.Object}">
                                <Setter Property="Visibility" Value="Visible"/>
                              </DataTrigger>
                            </Style.Triggers>
                          </Style>
                        </TextBox.Style>
                      </TextBox>

                    </Grid>

                    <!-- editor area -->
                    <ContentControl Grid.Column="1"
                                    Visibility="{Binding IsEditable, Converter={StaticResource BoolToVisibilityConverter}}">
                      <ContentControl.Style>
                        <Style TargetType="{x:Type ContentControl}">
                          <Setter Property="ContentTemplate">
                            <Setter.Value>
                              <DataTemplate>
                                <TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                         Background="#111318" Foreground="#E6E6E6" BorderBrush="#2C313A" />
                              </DataTemplate>
                            </Setter.Value>
                          </Setter>

                          <Style.Triggers>
                            <DataTrigger Binding="{Binding Editor}" Value="{x:Static local:TreeEditorKind.Enum}">
                              <Setter Property="ContentTemplate">
                                <Setter.Value>
                                  <DataTemplate>
                                    <ComboBox ItemsSource="{Binding Options}"
                                              SelectedItem="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              IsEditable="False"
                                              Background="#111318" Foreground="#E6E6E6" BorderBrush="#2C313A"/>
                                  </DataTemplate>
                                </Setter.Value>
                              </Setter>
                            </DataTrigger>

                            <DataTrigger Binding="{Binding Editor}" Value="{x:Static local:TreeEditorKind.NumberOrParam}">
                              <Setter Property="ContentTemplate">
                                <Setter.Value>
                                  <DataTemplate>
                                    <ComboBox ItemsSource="{Binding Options}"
                                              Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              IsEditable="True"
                                              Background="#111318" Foreground="#E6E6E6" BorderBrush="#2C313A"/>
                                  </DataTemplate>
                                </Setter.Value>
                              </Setter>
                            </DataTrigger>

                            <DataTrigger Binding="{Binding Editor}" Value="{x:Static local:TreeEditorKind.List}">
                              <Setter Property="ContentTemplate">
                                <Setter.Value>
                                  <DataTemplate>
                                    <ComboBox ItemsSource="{Binding Options}"
                                              SelectedItem="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              IsEditable="False"
                                              Background="#111318" Foreground="#E6E6E6" BorderBrush="#2C313A"/>
                                  </DataTemplate>
                                </Setter.Value>
                              </Setter>
                            </DataTrigger>

                            <DataTrigger Binding="{Binding Editor}" Value="{x:Static local:TreeEditorKind.Int}">
                              <Setter Property="ContentTemplate">
                                <Setter.Value>
                                  <DataTemplate>
                                    <TextBox Background="#111318" Foreground="#E6E6E6" BorderBrush="#2C313A">
                                      <TextBox.Text>
                                        <Binding Path="Value" Mode="TwoWay" UpdateSourceTrigger="PropertyChanged">
                                          <Binding.ValidationRules>
                                            <val:IntValidationRule />
                                          </Binding.ValidationRules>
                                        </Binding>
                                      </TextBox.Text>
                                    </TextBox>
                                  </DataTemplate>
                                </Setter.Value>
                              </Setter>
                            </DataTrigger>

                          </Style.Triggers>
                        </Style>
                      </ContentControl.Style>
                    </ContentControl>
                  </Grid>
                </DockPanel>
              </HierarchicalDataTemplate>
            </TreeView.Resources>
          </TreeView>
        </DockPanel>
      </Border>

      <!-- Right: field + details -->
      <Grid Grid.Column="1" Background="#14161A">
        <Grid.RowDefinitions>
          <RowDefinition Height="2*" />
          <RowDefinition Height="*" />
          <RowDefinition Height="160" />
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Margin="10" Background="#0F1115" BorderBrush="#2C313A" BorderThickness="1" CornerRadius="6">
          <oxy:PlotView Model="{Binding FieldPlotModel}" />
        </Border>

        <Border Grid.Row="1" Margin="10,0,10,10" Background="#0F1115" BorderBrush="#2C313A" BorderThickness="1" CornerRadius="6">
          <DockPanel>
            <TextBlock DockPanel.Dock="Top" Text="Selection Details" Padding="10" FontWeight="SemiBold" Foreground="#C9D1D9"/>
            <ScrollViewer VerticalScrollBarVisibility="Auto">
              <TextBox Text="{Binding SelectionDetails}"
                       IsReadOnly="True"
                       Background="#0F1115" Foreground="#E6E6E6"
                       BorderThickness="0"
                       Padding="10"
                       FontFamily="Consolas" />
            </ScrollViewer>
          </DockPanel>
        </Border>

        <Border Grid.Row="2" Margin="10,0,10,10" Background="#0F1115" BorderBrush="#2C313A" BorderThickness="1" CornerRadius="6">
          <DockPanel>
            <TextBlock DockPanel.Dock="Top" Text="Debug Output" Padding="10" FontWeight="SemiBold" Foreground="#C9D1D9"/>
            <ScrollViewer VerticalScrollBarVisibility="Auto">
              <TextBox x:Name="DebugOutput"
                       Text="{Binding DebugLog}"
                       IsReadOnly="True"
                       Background="#0F1115" Foreground="#E6E6E6"
                       BorderThickness="0"
                       Padding="10"
                       FontFamily="Consolas"
                       TextWrapping="Wrap" />
            </ScrollViewer>
          </DockPanel>
        </Border>
      </Grid>
    </Grid>
  </DockPanel>
</Window>
